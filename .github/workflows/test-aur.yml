name: Test AUR PKGBUILD

on:
  push:
    paths:
      - 'aur/**'
  pull_request:
    paths:
      - 'aur/**'
  workflow_dispatch:

jobs:
  validate-pkgbuild:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install dependencies
        run: pacman -Syu --noconfirm base-devel namcap

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PKGBUILD syntax
        run: |
          cd aur
          echo "=== Checking PKGBUILD syntax ==="
          source PKGBUILD
          echo "pkgname: $pkgname"
          echo "pkgver: $pkgver"
          echo "pkgdesc: $pkgdesc"
          echo "arch: ${arch[@]}"
          echo "depends: ${depends[@]}"
          echo "makedepends: ${makedepends[@]}"
          echo "=== PKGBUILD parsed successfully ==="

      - name: Run namcap linter
        run: |
          cd aur
          namcap PKGBUILD || echo "namcap warnings (non-fatal)"

      - name: Verify .SRCINFO
        run: |
          cd aur
          echo "=== Checking .SRCINFO ==="
          cat .SRCINFO
          grep -q "pkgbase = lokus" .SRCINFO
          grep -q "pkgver = " .SRCINFO
          echo "=== .SRCINFO valid ==="
